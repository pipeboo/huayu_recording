<!DOCTYPE html>
<html lang="zh-TW">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Huayu éŒ„éŸ³é é¢</title>
  <style>
    body { font-family: sans-serif; text-align: center; padding: 2rem; }
    button { margin: 1rem; padding: 1rem 2rem; font-size: 1.2rem; }
    audio { margin-top: 2rem; }
    #status { margin-top: 1rem; font-weight: bold; color: #555; }
  </style>
</head>
<body>
  <h1>Huayu éŒ„éŸ³é é¢</h1>
  <p id="codeDisplay"></p>
  <button id="startBtn">é–‹å§‹éŒ„éŸ³</button>
  <button id="stopBtn" disabled>åœæ­¢éŒ„éŸ³</button>
  <button id="uploadBtn" disabled>ä¸Šå‚³åˆ° Cloudinary</button>
  <br />
  <audio id="audioPlayer" controls></audio>
  <div id="status"></div>

  <script>
    const urlParams = new URLSearchParams(window.location.search);
    const code = urlParams.get("code");
    const key = urlParams.get("key");

    if (!code || !key) {
      document.body.innerHTML = '<h2>âŒ ç„¡æ•ˆçš„åƒæ•¸ï¼Œè«‹å¾é©—è­‰é é€²å…¥ã€‚</h2>';
      throw new Error("ç¼ºå°‘åƒæ•¸");
    }
    document.getElementById("codeDisplay").innerText = `ä»£ç¢¼ï¼š${code}`;

    let mediaRecorder;
    let audioChunks = [];
    let audioBlob;

    document.getElementById("startBtn").onclick = async () => {
      if (!navigator.mediaDevices) {
        document.getElementById("status").innerText = "æ­¤ç€è¦½å™¨ä¸æ”¯æ´éŒ„éŸ³ã€‚";
        return;
      }

      const stream = await navigator.mediaDevices.getUserMedia({ audio: true });
      mediaRecorder = new MediaRecorder(stream);
      audioChunks = [];
      mediaRecorder.ondataavailable = e => audioChunks.push(e.data);
      mediaRecorder.onstop = () => {
        audioBlob = new Blob(audioChunks, { type: 'audio/webm' });
        const audioURL = URL.createObjectURL(audioBlob);
        document.getElementById("audioPlayer").src = audioURL;
        document.getElementById("uploadBtn").disabled = false;
        document.getElementById("status").innerText = "âœ… éŒ„éŸ³å®Œæˆ";
      };

      mediaRecorder.start();
      document.getElementById("status").innerText = "ğŸ”´ éŒ„éŸ³ä¸­...";
      document.getElementById("startBtn").disabled = true;
      document.getElementById("stopBtn").disabled = false;
    };

    document.getElementById("stopBtn").onclick = () => {
      mediaRecorder.stop();
      document.getElementById("stopBtn").disabled = true;
    };

    document.getElementById("uploadBtn").onclick = async () => {
      if (!audioBlob) return;
      document.getElementById("status").innerText = "â¬†ï¸ ä¸Šå‚³ä¸­...";

      const formData = new FormData();
      formData.append("file", audioBlob);
      formData.append("upload_preset", "huayu_recording");

      const res = await fetch("https://api.cloudinary.com/v1_1/dcqb2xofg/video/upload", {
        method: "POST",
        body: formData
      });

      const data = await res.json();
      console.log("Cloudinary éŸ³è¨Šé€£çµï¼š", data.secure_url);
      document.getElementById("status").innerText = "âœ… ä¸Šå‚³æˆåŠŸï¼å³å°‡è·³è½‰...";

      // è·³è½‰å› WIX æ’­æ”¾é é¢ï¼ˆå¸¶å…¥ä»£ç¢¼ï¼‰
      setTimeout(() => {
        window.location.href = `https://kps0980.wixsite.com/huayu-dryflower/playback-entry?code=${code}`;
      }, 2000);
    };
  </script>
</body>
</html>
