<!DOCTYPE html>
<html lang="zh-Hant">
<head>
  <meta charset="UTF-8">
  <title>錄音器 - 語音卡片</title>
  <style>
    body { font-family: sans-serif; text-align: center; padding: 2rem; }
    button { padding: 1rem 2rem; font-size: 1.2rem; margin: 1rem; }
    audio { margin-top: 2rem; display: block; }
    #status { margin-top: 1rem; font-weight: bold; }
    audio {
    margin-top: 2rem;
    display: block;
    margin-left: auto;
    margin-right: auto;
    width: 300px;
  }
  </style>
</head>
<body>
  <h1>語音卡片錄音</h1>
  <p id="codeDisplay">正在載入代碼...</p>
  <button id="startBtn">開始錄音</button>
  <button id="stopBtn" disabled>停止錄音</button>
  <audio id="audioPlayback" controls></audio>
  <p id="status">尚未錄音</p>

  <script>
    const startBtn = document.getElementById('startBtn');
    const stopBtn = document.getElementById('stopBtn');
    const audioPlayback = document.getElementById('audioPlayback');
    const statusText = document.getElementById('status');
    const codeDisplay = document.getElementById('codeDisplay');

    let mediaRecorder;
    let audioChunks = [];

    // Get code from URL
    const urlParams = new URLSearchParams(window.location.search);
    const code = new URLSearchParams(window.location.search).get('code');
    if (!code) {
      codeDisplay.innerText = "錯誤：找不到識別代碼";
      startBtn.disabled = true;
    } else {
      codeDisplay.innerText = "識別碼：" + code;
    }

    startBtn.onclick = async () => {
      const stream = await navigator.mediaDevices.getUserMedia({ audio: true });
      mediaRecorder = new MediaRecorder(stream);
      audioChunks = [];

      mediaRecorder.ondataavailable = event => {
        audioChunks.push(event.data);
      };

      mediaRecorder.onstop = async () => {
        const audioBlob = new Blob(audioChunks, { type: 'audio/webm' });
        const formData = new FormData();
        formData.append('file', audioBlob);
        formData.append('upload_preset', 'huayu_recording');  // Replace with your preset
        formData.append('cloud_name', 'dcqb2xofg');         // Replace with your cloud name

        statusText.innerText = "上傳中...";

        // Upload to Cloudinary
        const uploadResp = await fetch('https://api.cloudinary.com/v1_1/dcqb2xofg/video/upload', {
          method: 'POST',
          body: formData
        });
        const uploadResult = await uploadResp.json();
        const audioUrl = uploadResult.secure_url;

        // Send to Vercel Proxy
        await fetch('https://huayu-recording.vercel.app/api/updateWixRecording', {
          method: 'POST',
          headers: {
            'Content-Type': 'application/json'
          },
          body: JSON.stringify({ code, audioUrl })
        });

        audioPlayback.src = audioUrl;
        statusText.innerText = "上傳完成！錄音連結已綁定。";
      };

      mediaRecorder.start();
      statusText.innerText = "錄音中...";
      startBtn.disabled = true;
      stopBtn.disabled = false;
    };

    stopBtn.onclick = () => {
      mediaRecorder.stop();
      stopBtn.disabled = true;
    };
  </script>
</body>
</html>