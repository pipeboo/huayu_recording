<!DOCTYPE html>
<html lang="zh-TW">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Huayu 錄音頁面</title>
  <style>
    body { font-family: sans-serif; text-align: center; padding: 2rem; }
    button { margin: 1rem; padding: 1rem 2rem; font-size: 1.2rem; }
    audio { margin-top: 2rem; }
    #status { margin-top: 1rem; font-weight: bold; color: #555; }
  </style>
</head>
<body>
  <h1>Huayu 錄音頁面</h1>
  <p id="codeDisplay"></p>
  <button id="startBtn">開始錄音</button>
  <button id="stopBtn" disabled>停止錄音</button>
  <button id="uploadBtn" disabled>上傳到 Cloudinary</button>
  <br />
  <audio id="audioPlayer" controls></audio>
  <div id="status"></div>

  <script>
    const urlParams = new URLSearchParams(window.location.search);
    const code = urlParams.get("code");
    const key = urlParams.get("key");

    if (!code || !key) {
      document.body.innerHTML = '<h2>❌ 無效的參數，請從驗證頁進入。</h2>';
      throw new Error("缺少參數");
    }
    document.getElementById("codeDisplay").innerText = `代碼：${code}`;

    let mediaRecorder;
    let audioChunks = [];
    let audioBlob;

    document.getElementById("startBtn").onclick = async () => {
      if (!navigator.mediaDevices) {
        document.getElementById("status").innerText = "此瀏覽器不支援錄音。";
        return;
      }

      const stream = await navigator.mediaDevices.getUserMedia({ audio: true });
      mediaRecorder = new MediaRecorder(stream);
      audioChunks = [];
      mediaRecorder.ondataavailable = e => audioChunks.push(e.data);
      mediaRecorder.onstop = () => {
        audioBlob = new Blob(audioChunks, { type: 'audio/webm' });
        const audioURL = URL.createObjectURL(audioBlob);
        document.getElementById("audioPlayer").src = audioURL;
        document.getElementById("uploadBtn").disabled = false;
        document.getElementById("status").innerText = "✅ 錄音完成";
      };

      mediaRecorder.start();
      document.getElementById("status").innerText = "🔴 錄音中...";
      document.getElementById("startBtn").disabled = true;
      document.getElementById("stopBtn").disabled = false;
    };

    document.getElementById("stopBtn").onclick = () => {
      mediaRecorder.stop();
      document.getElementById("stopBtn").disabled = true;
    };

    document.getElementById("uploadBtn").onclick = async () => {
      if (!audioBlob) return;
      document.getElementById("status").innerText = "⬆️ 上傳中...";

      const formData = new FormData();
      formData.append("file", audioBlob);
      formData.append("upload_preset", "huayu-recording");

      const res = await fetch("https://api.cloudinary.com/v1_1/dcqb2xofg/video/upload", {
        method: "POST",
        body: formData
      });

      const data = await res.json();

      try {
        const proxyRes = await fetch("https://huayu-recording.vercel.app/api/updateWixRecording", {
          method: "POST",
          headers: { "Content-Type": "application/json" },
          body: JSON.stringify({ code: code, audioUrl: data.secure_url })
        });

        const result = await proxyRes.json();
        if (!result.success) throw new Error(result.error || "WIX 更新失敗");

        document.getElementById("status").innerText = "✅ 上傳成功！即將跳轉...";
        setTimeout(() => {
          window.location.href = `https://kps0980.wixsite.com/huayu-dryflower/playback-entry?code=${code}`;
        }, 2000);
      } catch (err) {
        console.error("WIX 更新失敗", err);
        document.getElementById("status").innerText = "❌ 音訊上傳成功，但寫入資料失敗，請聯絡管理員";
      }
    };
  </script>
</body>
</html>
